import{_ as n,o as a,c as s,d as t}from"./app-HBA039kk.js";const p="/assets/20240216144529-JgekfPFd.png",e={},o=t('<h1 id="spring-cloud-alibaba-seata分布式事务" tabindex="-1"><a class="header-anchor" href="#spring-cloud-alibaba-seata分布式事务"><span>Spring Cloud Alibaba Seata分布式事务</span></a></h1><p>参考：</p><ul><li>https://sca.aliyun.com/zh-cn/docs/2022.0.0.0/user-guide/seata/overview</li><li>https://seata.io/zh-cn/</li><li>https://github.com/seata/seata</li></ul><p>版本：</p><ul><li>Seata Server 1.8.0</li><li>Spring Cloud Alibaba 2022.0.0.0</li></ul><h2 id="seata服务器" tabindex="-1"><a class="header-anchor" href="#seata服务器"><span>Seata服务器</span></a></h2><p>下载地址：https://github.com/seata/seata/releases/</p><h3 id="存储模式" tabindex="-1"><a class="header-anchor" href="#存储模式"><span>存储模式</span></a></h3><p>支持file和db2种事务模式：</p><ul><li>file，默认，全局事务会话信息保存在内存中，并异步持久化到本地文件。属于单机模式。</li><li>db，全局事务会话信息存储在数据库中，可通过db共享。</li><li>redis</li></ul><p>启动服务器：</p><ul><li><code>seata-server.bat -h 127.0.0.1 -p 8091 -m file</code></li><li><code>seata-server.bat -h 127.0.0.1 -p 8091 -m db</code></li></ul><h3 id="使用db存储模式" tabindex="-1"><a class="header-anchor" href="#使用db存储模式"><span>使用db存储模式</span></a></h3><blockquote><p>使用MySQL数据库</p></blockquote><p>db存储模式下，全局事务会话信息通过db共享。</p><h4 id="_1-建库建表" tabindex="-1"><a class="header-anchor" href="#_1-建库建表"><span>1.建库建表</span></a></h4><p>创建数据库seata，在其中创建下面的数据表</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------</span>\n<span class="token comment">-- the table to store GlobalSession data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>global_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>                       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>            <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>                    <span class="token keyword">TINYINT</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_id<span class="token punctuation">`</span></span>            <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_service_group<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_name<span class="token punctuation">`</span></span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>timeout<span class="token punctuation">`</span></span>                   <span class="token keyword">INT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>begin_time<span class="token punctuation">`</span></span>                <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>                <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>              <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status_gmt_modified<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_transaction_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token comment">-- the table to store BranchSession data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>branch_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>               <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>    <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_group_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_type<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>            <span class="token keyword">TINYINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span>         <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>        <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>      <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token comment">-- the table to store lock data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>lock_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span>        <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>            <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>table_name<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>pk<span class="token punctuation">`</span></span>             <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>         <span class="token keyword">TINYINT</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:locked ,1:rollbacking&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>     <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_branch_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span>       <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>lock_value<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>expire<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;AsyncCommitting&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;RetryCommitting&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;RetryRollbacking&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;TxTimeoutCheck&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><h4 id="_2-配置" tabindex="-1"><a class="header-anchor" href="#_2-配置"><span>2.配置</span></a></h4><p>修改 <em>conf/application.yml</em></p><div class="language-properties" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">seata</span><span class="token punctuation">:</span>\n<span class="token key attr-name">  config</span><span class="token punctuation">:</span>\n<span class="token comment">    # support: nacos, consul, apollo, zk, etcd3</span>\n<span class="token key attr-name">    type</span><span class="token punctuation">:</span> <span class="token value attr-value">file</span>\n<span class="token key attr-name">  registry</span><span class="token punctuation">:</span>\n<span class="token comment">    # support: nacos, eureka, redis, zk, consul, etcd3, sofa</span>\n<span class="token key attr-name">    type</span><span class="token punctuation">:</span> <span class="token value attr-value">file</span>\n<span class="token key attr-name">  store</span><span class="token punctuation">:</span>\n<span class="token comment">    # support: file 、 db 、 redis 、 raft</span>\n<span class="token key attr-name">    mode</span><span class="token punctuation">:</span> <span class="token value attr-value">db</span>\n<span class="token key attr-name">    session</span><span class="token punctuation">:</span>\n<span class="token key attr-name">      mode</span><span class="token punctuation">:</span> <span class="token value attr-value">db</span>\n<span class="token key attr-name">    lock</span><span class="token punctuation">:</span>\n<span class="token key attr-name">      mode</span><span class="token punctuation">:</span> <span class="token value attr-value">db</span>\n<span class="token key attr-name">    db</span><span class="token punctuation">:</span>\n<span class="token key attr-name">      datasource</span><span class="token punctuation">:</span> <span class="token value attr-value">druid</span>\n<span class="token key attr-name">      db-type</span><span class="token punctuation">:</span> <span class="token value attr-value">mysql</span>\n<span class="token key attr-name">      driver-class-name</span><span class="token punctuation">:</span> <span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>\n<span class="token key attr-name">      url</span><span class="token punctuation">:</span> <span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;rewriteBatchedStatements=true&amp;&amp;serverTimezone=Asia/Shanghai</span>\n<span class="token key attr-name">      user</span><span class="token punctuation">:</span> <span class="token value attr-value">root</span>\n<span class="token key attr-name">      password</span><span class="token punctuation">:</span> <span class="token value attr-value">root</span>\n<span class="token key attr-name">      min-conn</span><span class="token punctuation">:</span> <span class="token value attr-value">10</span>\n<span class="token key attr-name">      max-conn</span><span class="token punctuation">:</span> <span class="token value attr-value">100</span>\n<span class="token key attr-name">      global-table</span><span class="token punctuation">:</span> <span class="token value attr-value">global_table</span>\n<span class="token key attr-name">      branch-table</span><span class="token punctuation">:</span> <span class="token value attr-value">branch_table</span>\n<span class="token key attr-name">      lock-table</span><span class="token punctuation">:</span> <span class="token value attr-value">lock_table</span>\n<span class="token key attr-name">      distributed-lock-table</span><span class="token punctuation">:</span> <span class="token value attr-value">distributed_lock</span>\n<span class="token key attr-name">      query-limit</span><span class="token punctuation">:</span> <span class="token value attr-value">1000</span>\n<span class="token key attr-name">      max-wait</span><span class="token punctuation">:</span> <span class="token value attr-value">5000</span>\n</code></pre></div><p>如果使用nacos配置中心，需要在nacos中配置</p><div class="language-properties" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">#Transaction storage configuration, only for the server. The file, db, and redis configuration values are optional.</span>\n<span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n<span class="token key attr-name">store.lock.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n<span class="token key attr-name">store.session.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n\n<span class="token comment">#These configurations are required if the `store mode` is `db`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `db`, you can remove the configuration block.</span>\n<span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span>\n<span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>\n<span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>\n<span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;rewriteBatchedStatements=true&amp;&amp;serverTimezone=Asia/Shanghai</span>\n<span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>\n<span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>\n<span class="token key attr-name">store.db.minConn</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>\n<span class="token key attr-name">store.db.maxConn</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>\n<span class="token key attr-name">store.db.globalTable</span><span class="token punctuation">=</span><span class="token value attr-value">global_table</span>\n<span class="token key attr-name">store.db.branchTable</span><span class="token punctuation">=</span><span class="token value attr-value">branch_table</span>\n<span class="token key attr-name">store.db.distributedLockTable</span><span class="token punctuation">=</span><span class="token value attr-value">distributed_lock</span>\n<span class="token key attr-name">store.db.queryLimit</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n<span class="token key attr-name">store.db.lockTable</span><span class="token punctuation">=</span><span class="token value attr-value">lock_table</span>\n<span class="token key attr-name">store.db.maxWait</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span>\n</code></pre></div><h4 id="_3-启动服务器" tabindex="-1"><a class="header-anchor" href="#_3-启动服务器"><span>3.启动服务器</span></a></h4><p><code>seata-server.bat -h 127.0.0.1 -p 8091 -m db</code></p><h4 id="_4-访问控制台" tabindex="-1"><a class="header-anchor" href="#_4-访问控制台"><span>4.访问控制台</span></a></h4><p>http://localhost:7091/，用户名/密码默认为seata/seata</p><p><img src="'+p+`" alt=""></p><h3 id="使用nacos作为配置中心和注册中心" tabindex="-1"><a class="header-anchor" href="#使用nacos作为配置中心和注册中心"><span>使用nacos作为配置中心和注册中心</span></a></h3><h4 id="_1-在nacos控制台新建配置文件" tabindex="-1"><a class="header-anchor" href="#_1-在nacos控制台新建配置文件"><span>1.在nacos控制台新建配置文件</span></a></h4><ul><li>namespace：public</li><li>group：SEATA_GROUP</li><li>dataId：seataServer.properties</li></ul><h4 id="_2-配置seata服务端" tabindex="-1"><a class="header-anchor" href="#_2-配置seata服务端"><span>2.配置Seata服务端</span></a></h4><p><em>conf/application.yml</em></p><div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server

<span class="token comment"># Nacos</span>
<span class="token key atrule">nacos</span><span class="token punctuation">:</span>
  <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
  <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
  <span class="token key atrule">context-path</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public
  <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
  
<span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.username<span class="token punctuation">}</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.password<span class="token punctuation">}</span>
      <span class="token key atrule">context-path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.context<span class="token punctuation">-</span>path<span class="token punctuation">}</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.namespace<span class="token punctuation">}</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.group<span class="token punctuation">}</span>
      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.username<span class="token punctuation">}</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.password<span class="token punctuation">}</span>
      <span class="token key atrule">context-path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.context<span class="token punctuation">-</span>path<span class="token punctuation">}</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.namespace<span class="token punctuation">}</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.group<span class="token punctuation">}</span>
      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
</code></pre></div><h4 id="_3-配置seata客户端" tabindex="-1"><a class="header-anchor" href="#_3-配置seata客户端"><span>3.配置Seata客户端</span></a></h4><p>见下文</p><h2 id="seata集群与事务分组" tabindex="-1"><a class="header-anchor" href="#seata集群与事务分组"><span>Seata集群与事务分组</span></a></h2><p>Seata支持集群部署。</p><p>可将多个Seata服务端应用注册到Nacos注册中心，同时指定其cluster名称</p><p><em>conf/application.yml</em></p><div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
</code></pre></div><h3 id="客户端配置" tabindex="-1"><a class="header-anchor" href="#客户端配置"><span>客户端配置</span></a></h3><p>在Seata客户端</p><div class="language-properties" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># Seata Tx Group</span>
<span class="token comment"># 分组名</span>
<span class="token key attr-name">seata.tx-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default-tx-group</span>
<span class="token comment"># 分组名与集群名的映射关系</span>
<span class="token key attr-name">seata.service.vgroup-mapping.default-tx-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
</code></pre></div><h3 id="服务端配置" tabindex="-1"><a class="header-anchor" href="#服务端配置"><span>服务端配置</span></a></h3><p>定义事务分组与集群的映射关系，除了在客户端定义外，也可以在服务端定义。</p><p>修改Nacos控制台中的seata配置文件</p><div class="language-properties" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">#Transaction routing rules configuration, only for the client</span>
<span class="token key attr-name">service.vgroupMapping.default-tx-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
</code></pre></div><h2 id="at事务模式" tabindex="-1"><a class="header-anchor" href="#at事务模式"><span>AT事务模式</span></a></h2><p>AT模式涉及3个角色：</p><ul><li>TC，事务协调者，Seata服务器</li><li>TM，事务管理者，由<code>@GlobalTransactional</code>注解开启全局事务</li><li>RM，资源管理者，涉及的各个分支事务</li></ul><h3 id="快速开始" tabindex="-1"><a class="header-anchor" href="#快速开始"><span>快速开始</span></a></h3><p>1.在参与事务的每个客户端数据库中，创建undo_log表</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>context<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>rollback_info<span class="token punctuation">\`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_modified<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>ext<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>ux_undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p>2.将事务涉及到的每一个应用注册到Nacos注册中心</p><p>3.在事务涉及到的每一个应用中添加依赖</p><p>如果自动引入的<code>seata-spring-boot-starter</code>版本与seata服务器版本不一致，需要覆盖默认版本信息</p><div class="language-xml" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>4.配置</p><p>在参与事务的每个客户端应用中，进行以下配置</p><ul><li><p>配置Seata事务模式</p></li><li><p>配置事务分组及与集群的映射关系</p></li><li><p>Seata使用Nacos作为注册中心和配置中心，除了服务端以外，客户端也需要进行相应的配置</p></li></ul><div class="language-properties" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># Alibaba Nacos</span>
<span class="token key attr-name">spring.cloud.nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
<span class="token key attr-name">spring.cloud.nacos.username</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span>
<span class="token key attr-name">spring.cloud.nacos.password</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span>

<span class="token comment"># Alibaba Seata</span>
<span class="token key attr-name">seata.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">seata.data-source-proxy-mode</span><span class="token punctuation">=</span><span class="token value attr-value">AT</span>
<span class="token key attr-name">seata.enable-auto-data-source-proxy</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># Seata Tx Group</span>
<span class="token key attr-name">seata.tx-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default-tx-group</span>
<span class="token key attr-name">seata.service.vgroup-mapping.default-tx-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
<span class="token comment"># Seata Nacos Config</span>
<span class="token key attr-name">seata.config.type</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span>
<span class="token key attr-name">seata.config.nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.server-addr}</span>
<span class="token key attr-name">seata.config.nacos.username</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.username}</span>
<span class="token key attr-name">seata.config.nacos.password</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.password}</span>
<span class="token key attr-name">seata.config.nacos.namespace</span><span class="token punctuation">=</span><span class="token value attr-value">public</span>
<span class="token key attr-name">seata.config.nacos.group</span><span class="token punctuation">=</span><span class="token value attr-value">SEATA_GROUP</span>
<span class="token key attr-name">seata.config.nacos.data-id</span><span class="token punctuation">=</span><span class="token value attr-value">seataServer.properties</span>
<span class="token comment"># Seata Nacos Discovery</span>
<span class="token key attr-name">seata.registry.type</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span>
<span class="token key attr-name">seata.registry.nacos.application</span><span class="token punctuation">=</span><span class="token value attr-value">seata-server</span>
<span class="token key attr-name">seata.registry.nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.server-addr}</span>
<span class="token key attr-name">seata.registry.nacos.username</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.username}</span>
<span class="token key attr-name">seata.registry.nacos.password</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.cloud.nacos.password}</span>
<span class="token key attr-name">seata.registry.nacos.namespace</span><span class="token punctuation">=</span><span class="token value attr-value">public</span>
<span class="token key attr-name">seata.registry.nacos.group</span><span class="token punctuation">=</span><span class="token value attr-value">SEATA_GROUP</span>
<span class="token key attr-name">seata.registry.nacos.cluster</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
<span class="token key attr-name">seata.registry.nacos.context-path</span><span class="token punctuation">=</span>
</code></pre></div><p>5.在业务方法上，使用注解 <code>@GlobalTransactional</code> 开启全局事务</p><div class="language-java" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span> <span class="token keyword">private</span> <span class="token class-name">StorageService</span> storageService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span> <span class="token keyword">private</span> <span class="token class-name">AccountService</span> accountService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span> <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 购买商品
     * */</span>
    <span class="token annotation punctuation">@GlobalTransactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">purchase</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> productCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.扣减商品库存</span>
        <span class="token class-name">DeductParam</span> deductParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeductParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deductParam<span class="token punctuation">.</span><span class="token function">setProductId</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        deductParam<span class="token punctuation">.</span><span class="token function">setProductCount</span><span class="token punctuation">(</span>productCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        storageService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>deductParam<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.扣减钱包金额</span>
        <span class="token class-name">BigDecimal</span> amount <span class="token operator">=</span> <span class="token function">calcOrderAmount</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> productCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DebitParam</span> debitParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DebitParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        debitParam<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        debitParam<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountService<span class="token punctuation">.</span><span class="token function">debit</span><span class="token punctuation">(</span>debitParam<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.创建订单记录</span>
        <span class="token class-name">CreateOrderParam</span> createOrderParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateOrderParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        createOrderParam<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        createOrderParam<span class="token punctuation">.</span><span class="token function">setProductId</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        createOrderParam<span class="token punctuation">.</span><span class="token function">setProductCount</span><span class="token punctuation">(</span>productCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        createOrderParam<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createOrderParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * 计算订单金额
     * */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> <span class="token function">calcOrderAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> productCount<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ProductDTO</span> product <span class="token operator">=</span> storageService<span class="token punctuation">.</span><span class="token function">getProductInfo</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> productPrice <span class="token operator">=</span> product<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> productPrice<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>productCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="xa事务模式" tabindex="-1"><a class="header-anchor" href="#xa事务模式"><span>XA事务模式</span></a></h2><h2 id="tcc事务模式" tabindex="-1"><a class="header-anchor" href="#tcc事务模式"><span>TCC事务模式</span></a></h2><h2 id="saga事务模式" tabindex="-1"><a class="header-anchor" href="#saga事务模式"><span>Saga事务模式</span></a></h2>`,67),c=[o];function l(u,k){return a(),s("div",null,c)}const r=n(e,[["render",l],["__file","Spring Cloud Alibaba Seata分布式事务.html.vue"]]);export{r as default};
